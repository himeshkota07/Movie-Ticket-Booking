<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ratings - Movie Ticket Booking</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
      .ratings-container{padding:40px 0}
      .chart-card canvas{height:260px !important}
    </style>
</head>
<body>
<header class="site-header">
    <div class="container">
        <div class="logo"><a href="home.html">Movie Ticket Booking</a></div>
        <nav>
            <ul>
                <li><a href="home.html">Home</a></li>
                <li><a href="movies.html">Movies</a></li>
                <li><a href="ratings.html">Ratings</a></li>
                <li><a href="contact.html">Contact</a></li>
            </ul>
        </nav>
    </div>
</header>

<main class="container ratings-container">
    <h2>Top Rated Movies</h2>
    <p>Here are some of the highest-rated movies from our visitors.</p>

    <div class="charts">
        <div class="chart-card">
            <h3>Rating Comparison</h3>
            <canvas id="ratingsBarChart" width="600" height="300"></canvas>
        </div>
        <div class="chart-card">
            <h3>Ratings Distribution</h3>
            <canvas id="ratingsDoughnutChart" width="400" height="300"></canvas>
        </div>
    </div>

    <div id="ratingCards"></div>

    <section id="addRatingSection" style="margin-top:20px; background:white; padding:15px; border-radius:8px;">
        <h3>Add Your Rating</h3>
        <form id="addRatingForm" style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
            <label for="movieSelect">Movie:</label>
            <select id="movieSelect" required></select>
            <label for="ratingInput">Rating (1-5):</label>
            <input type="number" id="ratingInput" min="1" max="5" required>
            <label for="commentInput">Comment:</label>
            <input type="text" id="commentInput" maxlength="200" placeholder="Share your thoughts">
            <button type="submit">Submit Rating</button>
        </form>
    </section>

    <section id="reviewsSection" style="margin-top:20px;">
        <h3>Latest Reviews</h3>
        <div id="reviewsList" style="background:white; padding:15px; border-radius:8px;"></div>
    </section>

    <div style="margin-top: 20px;">
        <a href="movies.html"><button>Browse Movies</button></a>
        <a href="contact.html" style="margin-left:10px;"><button>Give Feedback</button></a>
    </div>
</main>

<footer>
    <p>&copy; 2025 Online Movie Ticket Booking System</p>
</footer>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initial movie data with counts and sample comments
const initialMovies = [
  { title: 'PUSHPA THE RULE', rating: 4.2, count: 1254, comments: ['Loved the performances!', 'Great soundtrack.'] },
  { title: 'DEVARA', rating: 4.0, count: 987, comments: ['A solid entertainer.'] },
  { title: 'BHOOL BHULAAIYA 3', rating: 3.6, count: 642, comments: ['Good thrills.'] },
  { title: 'MAD SQUARE', rating: 3.8, count: 420, comments: [] },
  { title: 'LUCKY BHASKER', rating: 4.1, count: 301, comments: [] },
  { title: 'KALKI 2898 AD', rating: 4.0, count: 256, comments: [] },
  { title: 'UNTIL DAWN', rating: 3.9, count: 190, comments: [] },
  { title: 'STREE 2', rating: 3.7, count: 210, comments: [] },
  { title: 'RETRO', rating: 3.5, count: 150, comments: [] }
];

// Load from localStorage if present
let movies = JSON.parse(localStorage.getItem('moviesRatings') || 'null') || initialMovies;

// Chart instances (created below)
let barChart, doughChart;

function starsFromRating(avg) {
  const r = Math.round(avg); // nearest whole star for display
  let stars = '';
  for (let i = 0; i < 5; i++) stars += (i < r) ? '★' : '☆';
  return stars;
}

function renderCards() {
  const container = document.getElementById('ratingCards');
  container.innerHTML = '';
  movies.forEach((m, idx) => {
    const card = document.createElement('div');
    card.className = 'rating-card';
    card.innerHTML = `
      <div>
        <h3>${m.title} <span class="stars">${starsFromRating(m.rating)}</span></h3>
        <p>Average Rating: ${m.rating.toFixed(2)} / 5</p>
      </div>
      <div>
        <p>Reviews: ${m.count.toLocaleString()}</p>
        <a href="review.html?id=${idx}"><button>View Reviews</button></a>
      </div>
    `;
    container.appendChild(card);
  });

  // review buttons now link to per-movie review pages via review.html?id=<index>
}

function renderCharts() {
  const labels = movies.map(m => m.title);
  const data = movies.map(m => Number(m.rating.toFixed(2)));

  // bar
  if (!barChart) {
    const barCtx = document.getElementById('ratingsBarChart').getContext('2d');
    barChart = new Chart(barCtx, {
      type: 'bar',
      data: { labels, datasets: [{ label: 'Average Rating', data, backgroundColor: 'rgba(231,76,60,0.85)', borderColor: 'rgba(192,57,43,1)', borderWidth: 1 }] },
      options: { scales: { y: { beginAtZero: true, suggestedMax: 5 } }, plugins: { legend: { display: false } } }
    });
  } else {
    barChart.data.labels = labels;
    barChart.data.datasets[0].data = data;
    barChart.update();
  }

  // doughnut
  if (!doughChart) {
    const doughCtx = document.getElementById('ratingsDoughnutChart').getContext('2d');
    doughChart = new Chart(doughCtx, {
      type: 'doughnut',
      data: { labels, datasets: [{ data, backgroundColor: ['#e74c3c','#c0392b','#f1c40f','#9b59b6','#3498db','#2ecc71','#e67e22','#1abc9c','#95a5a6'] }] },
      options: { plugins: { legend: { position: 'right' } } }
    });
  } else {
    doughChart.data.labels = labels;
    doughChart.data.datasets[0].data = data;
    doughChart.update();
  }
}

function populateMovieSelect() {
  const select = document.getElementById('movieSelect');
  select.innerHTML = '';
  movies.forEach((m, idx) => {
    const opt = document.createElement('option');
    opt.value = idx;
    opt.textContent = m.title;
    select.appendChild(opt);
  });
}

function renderReviews(idx = 0) {
  const list = document.getElementById('reviewsList');
  list.innerHTML = '';
  const movie = movies[idx];
  const heading = document.createElement('h4');
  heading.textContent = `Reviews for ${movie.title}`;
  list.appendChild(heading);

  if (!movie.comments || movie.comments.length === 0) {
    const p = document.createElement('p');
    p.textContent = 'No reviews yet — be the first!';
    list.appendChild(p);
    return;
  }

  movie.comments.slice(0, 20).forEach(c => {
    const div = document.createElement('div');
    div.style.borderBottom = '1px solid #eee';
    div.style.padding = '8px 0';
    div.textContent = c;
    list.appendChild(div);
  });
}

// Handle submit
document.addEventListener('DOMContentLoaded', () => {
  populateMovieSelect();
  renderCards();
  renderCharts();
  renderReviews(0);

  const form = document.getElementById('addRatingForm');
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const idx = Number(document.getElementById('movieSelect').value);
    const ratingInput = Number(document.getElementById('ratingInput').value);
    const comment = document.getElementById('commentInput').value.trim();

    if (!ratingInput || ratingInput < 1 || ratingInput > 5) return alert('Please enter a rating between 1 and 5.');

    const movie = movies[idx];
    const newCount = movie.count + 1;
    const newAvg = ((movie.rating * movie.count) + ratingInput) / newCount;
    movie.count = newCount;
    movie.rating = Number(newAvg.toFixed(2));
    if (!movie.comments) movie.comments = [];
    if (comment) movie.comments.unshift(comment);

    // persist
    localStorage.setItem('moviesRatings', JSON.stringify(movies));

    // update UI
    populateMovieSelect();
    renderCards();
    renderCharts();
    renderReviews(idx);

    // reset form
    form.reset();
    alert('Thanks — your rating has been submitted!');
  });
});
</script>
</body>
</html>